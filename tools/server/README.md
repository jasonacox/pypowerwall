# PyPowerwall Server

A modern, high-performance FastAPI-based server for monitoring and managing Tesla Powerwall systems. Designed as the next-generation evolution of the pypowerwall proxy with multi-gateway support, real-time monitoring, and a beautiful modern UI.

## Vision

PyPowerwall Server provides a comprehensive monitoring and management solution for Tesla Powerwall installations with:

- **Multiple Powerwall Support** - Monitor multiple homes/sites from a single server instance
- **Modern Web UI** - Beautiful, responsive interface with real-time power flow visualization
- **Full API Compatibility** - Maintains all existing proxy endpoints for backward compatibility
- **High Performance** - Built on FastAPI for speed and scalability
- **Container Ready** - Deploy via Docker or run standalone
- **WebSocket Support** - Real-time data streaming to connected clients

## Features

### Multi-Gateway Support

Connect to multiple Powerwall installations simultaneously:
- View individual gateway metrics
- Aggregate data across multiple sites
- Switch between gateways in the UI
- Per-gateway configuration and credentials

### Modern Web Interface

Comprehensive dashboard featuring:
- Real-time power flow animation (enhanced from current proxy)
- Live metrics: grid, solar, battery, home consumption
- Battery state of charge with time remaining
- Historical graphs and trends
- Gateway selector for multi-site management
- Responsive design for mobile and desktop
- Dark/light theme support

### Complete API

RESTful API providing:
- All existing proxy endpoints (GET and POST)
- Multi-gateway endpoints: `/api/gateways/{id}/vitals`
- Aggregated data endpoints: `/api/aggregate/power`
- WebSocket endpoints for real-time streaming
- OpenAPI documentation (auto-generated by FastAPI)

### Deployment Options

- **Docker Container** - `pypowerwall-server` image
- **Docker Compose** - Multi-container setup with persistence
- **Standalone** - Direct Python execution
- **Kubernetes** - Helm chart support

## Quick Start

### Docker (Recommended)

```bash
docker run -d \
  --name pypowerwall-server \
  -p 8080:8080 \
  -e PW_HOST=192.168.91.1 \
  -e PW_PASSWORD=your_gateway_password \
  jasonacox/pypowerwall-server
```

Visit http://localhost:8080

### Multiple Powerwalls

```bash
docker run -d \
  --name pypowerwall-server \
  -p 8080:8080 \
  -e PW_GATEWAYS='[
    {"id": "home", "name": "Home Gateway", "host": "192.168.91.1", "password": "gateway_password_1"},
    {"id": "cabin", "name": "Cabin Gateway", "host": "192.168.91.1", "password": "gateway_password_2"}
  ]' \
  jasonacox/pypowerwall-server
```

### Command Line

```bash
# Install
pip install pypowerwall-server

# Single Powerwall
pypowerwall-server --host 192.168.91.1 --password your_gateway_password

# Multiple Powerwalls
pypowerwall-server --config gateways.yaml
```

## Configuration

> **Note**: Most users will use **TEDAPI** to connect to their Powerwall gateway, which is accessible at the standard IP address `192.168.91.1` on your local network. You'll need your gateway password (found in the Tesla app under your gateway settings).

### Cloud Authentication Setup (Optional, for Control Operations)

If you want to control your Powerwall (set reserve level, operating mode, etc.), you'll need Tesla Cloud authentication:

**One-time setup:**
```bash
python3 -m pypowerwall setup
```

This will:
1. Open your browser to authenticate with Tesla
2. Generate `.pypowerwall.auth` and `.pypowerwall.site` token files
3. Store them in the default location or a specified directory

**Then configure the server:**
```bash
PW_AUTHPATH=/path/to/auth/directory  # Directory containing the auth files
```

For Docker, mount the auth directory:
```bash
docker run -v /host/path/to/auth:/auth \
  -e PW_AUTHPATH=/auth \
  ...
```

### Environment Variables

**Single Gateway Mode (Read-Only via TEDAPI):**
```bash
PW_HOST=192.168.91.1
PW_PASSWORD=your_gateway_password
PW_TIMEZONE=America/Los_Angeles
SERVER_PORT=8080
SERVER_HOST=0.0.0.0
```

**Single Gateway Mode (With Cloud Control):**
```bash
PW_HOST=192.168.91.1
PW_PASSWORD=your_gateway_password          # For TEDAPI data reads
PW_EMAIL=your-tesla-account@email.com
PW_AUTHPATH=/path/to/auth/files            # Directory with .pypowerwall.auth/.site
PW_TIMEZONE=America/Los_Angeles
```

**Multi-Gateway Mode:**
```bash
PW_GATEWAYS='[
  {
    "id": "home",
    "name": "Home System", 
    "host": "192.168.91.1",
    "password": "gw_pwd_1",
    "email": "tesla@email.com",
    "authpath": "/auth"
  },
  {
    "id": "cabin",
    "name": "Cabin System",
    "host": "192.168.91.1",
    "password": "gw_pwd_2",
    "email": "tesla@email.com",
    "authpath": "/auth"
  }
]'
```

### Configuration File (gateways.yaml)

```yaml
server:
  host: 0.0.0.0
  port: 8080
  cors_origins:
    - http://localhost:3000

gateways:
  - id: home
    name: Home System
    host: 192.168.91.1
    password: gw_pwd_1
    email: tesla@email.com
    authpath: /auth
    timezone: America/Los_Angeles
    
  - id: cabin
    name: Cabin System
    host: 192.168.91.1
    password: gw_pwd_2
    email: tesla@email.com
    authpath: /auth
    timezone: America/Denver
    
  - id: cloud-site
    name: Cloud Mode Site
    email: user@example.com
    authpath: /auth
    cloud_mode: true
```

**Authentication:**
- `password`: For TEDAPI local gateway access
- `email` + `authpath`: For Tesla Cloud API (control operations)
  - Run `python3 -m pypowerwall setup` to authenticate and generate auth files
  - Specify directory containing `.pypowerwall.auth` and `.pypowerwall.site` files

## API Endpoints

### Legacy Proxy Compatibility

All existing proxy endpoints work unchanged:
- `GET /vitals` - Device vitals
- `GET /aggregates` - Power aggregates
- `GET /soe` - State of energy
- `GET /freq` - Frequency data
- `GET /pod` - Battery pod data
- `POST /control/reserve` - Set battery reserve
- ... and all others

### Multi-Gateway Endpoints

**Gateway Selection:**
- `GET /api/gateways` - List all configured gateways
- `GET /api/gateways/{id}` - Gateway details
- `GET /api/gateways/{id}/vitals` - Gateway-specific vitals
- `GET /api/gateways/{id}/aggregates` - Gateway-specific power data

**Aggregated Data:**
- `GET /api/aggregate/power` - Combined power across all gateways
- `GET /api/aggregate/soe` - Total battery capacity and charge
- `GET /api/aggregate/status` - Health status of all gateways

**WebSocket Endpoints:**
- `WS /ws/gateway/{id}` - Real-time data stream for specific gateway
- `WS /ws/aggregate` - Real-time aggregated data stream

### Interactive API Documentation

- Swagger UI: http://localhost:8080/docs
- ReDoc: http://localhost:8080/redoc
- OpenAPI JSON: http://localhost:8080/openapi.json

## Design Decisions

### Cloud Authentication with Auth Tokens

The server supports **Tesla Cloud authentication** for control operations:

**TEDAPI (Local)**: For fast data reads from `192.168.91.1`
- Requires: `host` + `password` (gateway password)
- Fast response times (local network)
- No internet dependency
- Used for monitoring metrics

**Cloud (Control)**: For control operations via Tesla API
- Requires: `email` + `authpath`
- Setup: Run `python3 -m pypowerwall setup` to authenticate
- Generates: `.pypowerwall.auth` and `.pypowerwall.site` token files
- Used for: Setting reserve level, operating mode, etc.

**Configuration:**
```bash
# TEDAPI only (monitoring)
PW_HOST=192.168.91.1
PW_PASSWORD=gateway_password

# TEDAPI + Cloud (monitoring + control)
PW_HOST=192.168.91.1
PW_PASSWORD=gateway_password
PW_EMAIL=tesla@email.com
PW_AUTHPATH=/path/to/auth  # Directory with .pypowerwall.auth/.site files
```

### Async + Sync Library Integration
FastAPI is async, but pypowerwall is synchronous. This is handled using `asyncio.run_in_executor()` to run blocking pypowerwall calls in thread pools, preventing event loop blocking. This is the standard pattern for integrating sync libraries with async frameworks and works perfectly.

### Stateless Server Architecture
The server maintains no persistent state or historical data. All historical data for graphs is stored in **browser localStorage**, allowing:
- Server restarts without data loss (data persists in browser)
- Horizontal scaling (no shared state required)
- Minimal server resource usage
- Simple deployment model

### Control Features & Security
**Default: Read-only** - The server operates in monitoring mode by default.

**Optional Control Mode**: Enable with environment variables:
```bash
CONTROL_ENABLED=true
CONTROL_TOKEN=your-secure-random-token
```

When control is enabled:
- All control operations require authentication via token
- Token must be sent in `Authorization` header
- Legacy POST endpoints are disabled (redirect to `/control` endpoint)
- UI requires authentication for control features

Similar to the proxy server's auth model but token-based for better security.

### Data Aggregation Strategy
Multi-gateway aggregation uses **smart aggregation** that will evolve over time:

Current implementation (v0.1.0):
- Battery %: Simple average (TODO: weighted by capacity)
- Power flows: Simple sum (works for independent systems)
- Grid power: Calculated as site - solar

Future considerations documented in code:
- Capacity-weighted averages
- Different strategies per metric type
- Handling mixed local/cloud gateways
- Time synchronization across gateways
- Outlier detection

This area is expected to need tuning as real-world multi-gateway deployments provide feedback.

### Performance & Caching
- **Polling interval**: 5 seconds (configurable later if needed)
- **WebSocket updates**: Real-time to UI (1-second interval)
- **No server-side caching**: Fresh data on every request
- **Browser caching**: Historical data in localStorage

### UI Framework
Vanilla JavaScript - lightweight, no build step, fast loading. Charts and advanced features can be added incrementally without framework overhead.

## Architecture

```
tools/server/
├── app/
│   ├── main.py                 # FastAPI application entry point
│   ├── config.py               # Configuration management
│   ├── api/
│   │   ├── __init__.py
│   │   ├── legacy.py           # Legacy proxy endpoints
│   │   ├── gateways.py         # Multi-gateway endpoints
│   │   ├── aggregates.py       # Aggregated data endpoints
│   │   └── websockets.py       # WebSocket handlers
│   ├── core/
│   │   ├── __init__.py
│   │   ├── gateway_manager.py  # Manages multiple Powerwall instances
│   │   ├── data_aggregator.py  # Aggregates multi-gateway data
│   │   └── cache.py            # Response caching
│   ├── models/
│   │   ├── __init__.py
│   │   ├── gateway.py          # Gateway configuration models
│   │   ├── powerwall.py        # Powerwall data models
│   │   └── responses.py        # API response models
│   └── static/
│       ├── index.html          # Modern UI entry point
│       ├── css/
│       ├── js/
│       └── assets/
├── tests/
│   ├── test_api.py
│   ├── test_gateways.py
│   └── test_aggregates.py
├── Dockerfile
├── docker-compose.yml
├── pyproject.toml
└── README.md
```

## Development

### Setup

```bash
# Navigate to server directory
cd tools/server

# Create virtual environment
python -m venv venv
source venv/bin/activate  # or `venv\Scripts\activate` on Windows

# Install dependencies
pip install -e ".[dev]"

# Run development server with auto-reload
uvicorn app.main:app --reload --port 8080
```

### Running Tests

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=app --cov-report=html

# Run specific test file
pytest tests/test_api.py -v
```

### Building Docker Image

```bash
docker build -t pypowerwall-server .
docker run -p 8080:8080 pypowerwall-server
```

## Migration from Proxy

PyPowerwall Server maintains full backward compatibility with the existing proxy:

1. **Same API Endpoints** - All proxy routes work identically
2. **Environment Variables** - Same configuration options
3. **Drop-in Replacement** - Change container image, keep configs
4. **Telegraf/Grafana** - No changes needed to integrations

**Migration Steps:**
```bash
# Stop old proxy
docker stop pypowerwall-proxy

# Start new server (same port)
docker run -d \
  --name pypowerwall-server \
  -p 8675:8080 \
  -e PW_HOST=192.168.91.1 \
  -e PW_PASSWORD=your_gateway_password \
  jasonacox/pypowerwall-server
```

## Performance

- **Response Times** - Sub-50ms for cached endpoints
- **Concurrency** - Handle 1000+ concurrent connections
- **Memory** - ~100MB base, +20MB per gateway
- **WebSockets** - Support for hundreds of simultaneous connections

## Technology Stack

- **FastAPI** - Modern, fast web framework
- **Uvicorn** - Lightning-fast ASGI server
- **Pydantic** - Data validation and settings management
- **pypowerwall** - Core Powerwall communication library
- **aiohttp** - Async HTTP client for concurrent gateway polling
- **WebSockets** - Real-time data streaming
- **Modern UI** - HTML5, CSS3, JavaScript (framework TBD)

## Roadmap

- [x] Project planning and architecture
- [ ] Core FastAPI application structure
- [ ] Gateway manager implementation
- [ ] Legacy proxy endpoint compatibility
- [ ] Multi-gateway API endpoints
- [ ] Modern web UI with power flow
- [ ] WebSocket real-time streaming
- [ ] Docker containerization
- [ ] Unit and integration tests
- [ ] Documentation and examples
- [ ] Performance benchmarking
- [ ] Beta release

## Contributing

See [CONTRIBUTING.md](../../CONTRIBUTING.md) for development guidelines.

## License

MIT License - See [LICENSE](../../LICENSE) for details.

## Support

- **Issues:** https://github.com/jasonacox/pypowerwall/issues
- **Discussions:** https://github.com/jasonacox/pypowerwall/discussions
- **Wiki:** https://github.com/jasonacox/pypowerwall/wiki

---

**Note:** This project maintains the existing pypowerwall proxy unchanged. The proxy will continue to receive bug fixes and firmware updates while pypowerwall-server is developed as its modern replacement.
